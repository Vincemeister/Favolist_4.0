<div class="product-card">
    <div class="product-header">
      <% if controller_name == 'products' && action_name == 'show' %>
        <%= link_to :back do %>
          <i class="fa-regular fa-arrow-left"></i>
        <% end %>
      <% else %>
        <div></div>
      <% end %>
      <div class="list-and-title-and-price">
        <% unless controller_name == 'lists' && action_name == 'show' %>
          <div class="list-name"><%= product.list.name %></div>
        <% end %>
        <%= link_to product_path(product) do %>
          <div class="product-title"><%= product.title  %></div>
          <div class="price">$<%= product.price.to_i %></div>
        <% end %>
      </div>
      <i class="fa-sharp fa-regular fa-ellipsis" data-bs-toggle="modal" data-bs-target="#editOrDeleteModal-<%= product.id %>"></i>
    </div>



<% if product.photos.attached? && product.photos.count > 1 %>
  <div id="carouselExampleIndicators" class="carousel slide product-card-image">
    <div class="carousel-indicators">
      <% product.photos.each_with_index do |photo, index| %>
        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="<%= index %>" class="<%= 'active' if index.zero? %>" aria-label="Slide <%= index + 1 %>"></button>
      <% end %>
    </div>
    <div class="carousel-inner">
      <% product.photos.each_with_index do |photo, index| %>
        <div class="carousel-item <%= 'active' if index.zero? %>">
          <%= image_tag photo, class: "d-block" %>
        </div>
      <% end %>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
<% elsif product.photos.attached? %>
  <div class="product-card-image">
    <%= image_tag product.photos.first %>
  </div>
<% else %>
  <p>No image available</p>
<% end %>




    <div class="cardbar">
      <div class="cardbar-left">
        <%= link_to user_path(product.user) do %>
          <%= image_tag product.user.avatar, class: 'avatar-small' %>
        <% end %>
        <%= link_to user_path(product.user) do %>
          <div class="username">
            <%= product.user.username %>
          </div>
        <% end %>
      </div>
      <% if product.logo.attached? %>
          <%= image_tag product.logo, class: "cardbar-logo" %>
      <% else %>
        <p>No image available</p>
      <% end %>
      <div class="cardbar-right">
        <div class="cardbar-iconbox">
          <i class="fa-sharp fa-light fa-bookmark"></i>
          <div class="iconbox-text">30</div>
        </div>
        <div class="cardbar-iconbox">
          <i class="fa-light fa-circle-plus"></i>
          <div class="iconbox-text">30</div>
        </div>
        <%= link_to product_comments_path(product) do %>
          <div class="cardbar-iconbox">
            <i class="fa-light fa-comment"></i>
            <div class="iconbox-text"><%= product.comments.count %></div>
          </div>
        <% end %>
      </div>
    </div>

  <% if controller_name == 'products' && action_name == 'show' %>
  <!--Full product review, description and referral tabs if in product show page -->
    <ul class="nav nav-pills nav-fill w-100" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link custom-nav-link active product-tabs" id="pills-review-tab" data-bs-toggle="pill" data-bs-target="#pills-review" type="button" role="tab" aria-controls="pills-review" aria-selected="true">Review</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link custom-nav-link product-tabs" id="pills-description-tab" data-bs-toggle="pill" data-bs-target="#pills-description" type="button" role="tab" aria-controls="pills-description" aria-selected="false">Description</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link custom-nav-link product-tabs" id="pills-referrals-tab" data-bs-toggle="pill" data-bs-target="#pills-referrals" type="button" role="tab" aria-controls="pills-referrals" aria-selected="false">Referrals</button>
      </li>
    </ul>
    <div class="tab-content product-content" id="pills-tabContent">
      <div class="tab-pane fade show active linebreak" id="pills-review" role="tabpanel" aria-labelledby="pills-review-tab">
        <div class="context-text">
          <%= simple_format(@product.review) %></p>
        </div>
      </div>
      <div class="tab-pane fade linebreak" id="pills-description" role="tabpanel" aria-labelledby="pills-description-tab">
        <div class="content-text">
          <%= simple_format(@product.description) %>
        </div>
      </div>
      <div class="tab-pane fade linebreak" id="pills-referrals" role="tabpanel" aria-labelledby="pills-referrals-tab">
        <% product.referrals.each do |referral| %>
        <%# applying the referral card but only adjusting the referral details and code frame, adjusting padding %>
          <div class="referral-card px-0">
            <div class="referral-details content-text ">
              <%= referral.details %>
            </div>
            <div class="code-frame">
              <%= referral.code %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <% else %>

  <!--Truncated review snippet if in a feed page -->
    <div class="product-card-review content-text">
      <%= link_to product_path(product) do %>
        <div class="truncate-3-lines">
          <%= product.review%>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!--Edit or delete modal, bootstrap -->

<!-- Edit or delete modal -->
<div class="modal fade" id="editOrDeleteModal-<%= product.id %>" tabindex="-1" aria-labelledby="editOrDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body custom-modal">
        <button type="button" class="btn-close custom-modal-close-button" data-bs-dismiss="modal" aria-label="Close"></button>
        <h5><%= product.title %></h5>
        <div class="btn btn-danger w-100" data-bs-target="#deleteModal-<%= product.id %>" data-bs-toggle="modal" data-bs-dismiss="modal" %>Delete</div>
        <%= link_to 'Edit', edit_product_path(product), class: "btn btn-primary w-100" %>
      </div>
    </div>
  </div>
</div>

<!-- Delete modal -->
<div class="modal fade" id="deleteModal-<%= product.id %>" aria-hidden="true" aria-labelledby="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body custom-modal">
        <button type="button" class="btn-close custom-modal-close-button" data-bs-dismiss="modal" aria-label="Close"></button>
        <i class="fa-sharp fa-light fa-trash-can custom-modal-icon"></i>
        <h5>Are you sure you want to delete this listing?</h5>
        <p>All related data including comments will be permanently deleted.</p>
        <%= link_to 'Yes, please delete', product_path(product),  data: {turbo_method: :delete}, class: "btn btn-danger w-100" %>

        <button type="button w-100" class="btn btn-secondary w-100" data-bs-dismiss="modal">No, I want to keep this listing.</button>
      </div>
    </div>
  </div>
</div>
